# 第三模块作业

## 前言
[可选，用于总体上描述本篇文档的内容和目的]

[样例：本文是游戏业务线消息队列中间件详细架构设计文档，用于指导消息队列后续的开发、测试和运维]


## 词汇表
[可选，用于明确定义和说明一些英文缩写、术语等，请用表格来呈现，infoq 写作平台不支持表格，所以只能一个一个的列]

[样例：
Reactor: 网络编程模式
Netty: 开源的网络编程框架
]


## 1. 业务背景
[必选，从以下常见的角度来回答，你准备构建或者重构系统的目的和所处的位置是什么，可以是 1 个角度，也可以是多个角度，一般挑选重点的 3 个目的就差不多了：1.解决什么问题；2.带来什么价值；3.实现什么目标；4.完成什么任务；5.处于什么地位。
]

[样例：
随着前浪微博业务的不断发展，业务上拆分的子系统越来越多，目前系统间的调用都是同步调用，由此带来几个明显的系统问题：
- 性能问题：当用户发布了一条微博后，微博发布子系统需要同步调用“统计子系统”“审核子系统”“奖励子系统”等共 8 个子系统，性能很低。
- 耦合问题：当新增一个子系统时，例如如果要增加“广告子系统”，那么广告子系统需要开发新的接口给微博发布子系统调用。
- 效率问题：每个子系统提供的接口参数和实现都有一些细微的差别，导致每次都需要重新设计接口和联调接口，开发团队和测试团队花费了许多重复工作量。
基于以上背景，我们需要引入消息队列进行系统解耦，将目前的同步调用改为异步通知。
]
[技巧：使用系统边界黑盒图来描述系统与外界的边界和交互关系]



## 2. 约束和限制
[必选，列出明确的约束和限制，常见的约束和限制有：1.投资方的成本要求；2. 监管方的监管要求；3. 技术选型的硬性要求；4. 项目时间要求；5. 质量要求]
[样例：
1. 必须在 2021.06.30 号完成
2. 成本不能超过 1000 万
3. 数据库采用 Oracle
4. 质量标准符合 ISO9001-XXXX 标准
]
[技巧：约束和限制越多越好]


## 3. 总体架构
[必选，描述经过备选架构决策后定下来的架构方案，这一章主要是描述架构的 3R：Rank、Role、Relation]

[技巧：
1. 系统边界白盒图描述系统内的角色与外界的交互(Rank + Role + 外部 Relation)；
2. 系统架构图来描述内部的 Role + 内部 Relation
]

[注意：不建议一张图同时描述系统架构的 3R 以及与外界的交互，因为图太复杂，画系统边界白盒图的时候，系统内部的 Relation 可以不画]


### 3.1 架构分析
[可选，这部分主要是架构复杂度的分析，基本上从备选架构文档中提炼关键内容过来即可]
[样例：

3.1.1 高可用

对于微博子系统来说，如果消息丢了，导致没有审核，然后触犯了国家法律法规，则是非常严重的事情；对于等级子系统来说，如果用户达到相应等级后，系统没有给他奖品和专属服务，则 VIP 用户会很不满意，导致用户流失从而损失收入，虽然也比较关键，但没有审核子系统丢消息那么严重。

 

综合来看，消息队列需要高可用性，包括消息写入、消息存储、消息读取都需要保证高可用性。

]

[技巧：常见的复杂度都要覆盖到，即使分析后不涉及也要描述，避免评审的时候被人认为遗漏了关键点]



### 3.2 总体架构
[必选，描述总体架构设计]

[样例：此处省略架构图，文字描述样例：
1. 采用数据分散集群的架构，集群中的服务器进行分组，每个分组存储一部分消息数据。
2. 每个分组包含一台主 MySQL 和一台备 MySQL，分组内主备数据复制，分组间数据不同步。
3. 正常情况下，分组内的主服务器对外提供消息写入和消息读取服务，备服务器不对外提供服务；主服务 
4. 器宕机的情况下，备服务器对外提供消息读取的服务。
5. 客户端采取轮询的策略写入和读取消息。
]

[技巧：
1. 用系统架构图来描述架构，如果是前端或者客户端，用前端架构图或客户端架构图来描述架构
2. 基于架构图中的内容，使用文字描述 Role、Relation 的基本内容，文档目录可以自由调整
]

## 4. 详细设计
[必选，描述核心场景或者流程的实现机制]

### 4.1 核心功能
[必选，描述核心场景或者流程的实现机制，对应 4R 架构中的 Rule，每个核心场景一个小节]

[样例：
4.1.1 消息发送流程
4.1.2 消息消费流程
]

[技巧：使用系统序列图来描述 Rule，跟项目开发中写设计文档一样的写法]


### 4.2 关键设计
[必选，描述系统的一些关键设计点是如何实现和取舍的]

[样例（如果你有兴趣，可以对比一下 kafka 的文档：Kafka design）：
1）消息发送可靠性
业务服务器中嵌入消息队列系统提供的 SDK，SDK 支持轮询发送消息，当某个分组的主服务器无法发送消息时，SDK 挑选下一个分组主服务器重发消息，依次尝试所有主服务器直到发送成功；如果全部主服务器都无法发送，SDK 可以缓存消息，也可以直接丢弃消息，具体策略可以在启动 SDK 的时候通过配置指定。
如果 SDK 缓存了一些消息未发送，此时恰好业务服务器又重启，则所有缓存的消息将永久丢失，这种情况 SDK 不做处理，业务方需要针对某些非常关键的消息自己实现永久存储的功能。
2）消息存储可靠性
消息存储在 MySQL 中，每个分组有一主一备两台 MySQL 服务器，MySQL 服务器之间复制消息以保证消息存储高可用。如果主备间出现复制延迟，恰好此时 MySQL 主服务器宕机导致数据无法恢复，则部分消息会永久丢失，这种情况不做针对性设计，DBA 需要对主备间的复制延迟进行监控，当复制延迟超过 30 秒的时候需要及时告警并进行处理。
3）消息如何存储
每个消息队列对应一个 MySQL 表，消息队列名就是表名，表结构设计为……(此处请自行补充）
]
[技巧：常见的关键设计点包括高性能、高可用、可扩展、安全等]


### 4.3 设计规范
[必选，描述 Role 和 Relation 相关的开发框架、连接协议、数据包格式等]

[样例：
1）消息队列服务器使用 Spring Boot + Netty 开发
2）MySQL 使用 Innodb 存储引擎
3）TCP 包的结构设计……（此处省略，请自行补充）
]

[技巧：如果某个规范涉及内容比较多，请独立章节描述，例如数据包格式定义]

## 5. 质量设计
[必选，描述和质量相关的设计，包括：可测试性、可维护性、可观测性、成本等设计]

[样例：
5.1 消息队列管理后台
5.2 成本
]

[技巧：如果某个维度不涉及，也请在文档中说明，避免评审的时候被认为考虑不周全]

## 6. 演进规划
[必选，可以是演进规划，也可以是项目计划，需要描述每个里程碑或者版本具体要实现的能力]

[样例：
6.1 消息队列一期
6.2 消息队列二期
]

[技巧：开发阶段快速迭代，小步快跑，但要基本完善后才能正式推出给其他人用]